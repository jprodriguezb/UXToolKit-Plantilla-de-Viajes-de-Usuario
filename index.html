<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ§­ Lienzo: Plantilla de Viajes de Usuario (UX)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print { .no-print { display:none!important; } }
    .error { border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239,68,68,.15); }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="bg-white/80 backdrop-blur sticky top-0 z-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">ğŸ§­ Plantilla de Viajes de Usuario UX</h1>
      <div class="flex gap-2 no-print">
        <input id="fileJSON" type="file" accept="application/json,.json" class="hidden" />
        <button id="importJSON" class="px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 text-sm font-semibold" title="Importa un archivo JSON con tus viajes">Importar JSON</button>
        <button id="exportJSON" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-semibold" title="Exporta el viaje actual a JSON">Exportar JSON</button>
        <button id="clearAll" class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm font-semibold" title="VacÃ­a todo">Vaciar</button>
        <button id="printBtn" class="px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-black text-sm font-semibold" title="Imprimir / PDF">Imprimir</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Formulario principal -->
    <section class="lg:col-span-2">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200">
          <h2 class="text-xl font-semibold">Crear/Agregar etapa del Viaje</h2>
        </div>
        <form id="journeyForm" class="p-5 grid md:grid-cols-2 gap-4">
          <!-- Fase como campo de texto -->
          <div>
            <label for="fase" class="block text-sm font-medium mb-1">Fase</label>
            <input id="fase" name="fase" type="text" placeholder="Ej: Antes, Durante, DespuÃ©s, Onboarding, etc." class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" required />
          </div>
          <!-- DescripciÃ³n corta de la etapa -->
          <div>
            <label for="descripcion" class="block text-sm font-medium mb-1">DescripciÃ³n</label>
            <input id="descripcion" name="descripcion" type="text" placeholder="Breve descripciÃ³n de la etapa" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" required/>
          </div>

          <!-- Touchpoint (select con grupos) -->
          <div class="md:col-span-2">
            <label for="touchpoint" class="block text-sm font-medium mb-1">Touchpoint</label>
            <select id="touchpoint" name="touchpoint" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" required>
              <option value="">Selecciona un touchpointâ€¦</option>
              <optgroup label="ğŸ”‘ Acceso y autenticaciÃ³n">
                <option>Pantalla de inicio de sesiÃ³n ğŸ”‘</option>
                <option>Registro / creaciÃ³n de cuenta ğŸ“</option>
                <option>RecuperaciÃ³n de contraseÃ±a / autenticaciÃ³n de dos pasos ğŸ“²</option>
              </optgroup>
              <optgroup label="ğŸ§­ NavegaciÃ³n y exploraciÃ³n">
                <option>MenÃº principal / barra de navegaciÃ³n ğŸ“‚</option>
                <option>Buscador ğŸ”</option>
                <option>MenÃºs desplegables ğŸ“‘</option>
                <option>Filtros y ordenamientos ğŸ—‚ï¸</option>
                <option>Breadcrumbs / rutas de navegaciÃ³n ğŸ§µ</option>
              </optgroup>
              <optgroup label="ğŸ› ï¸ Interacciones principales">
                <option>Botones CTA (Call To Action) ğŸ‘‰</option>
                <option>Formularios (inputs, selectores, checkboxes) ğŸ“</option>
                <option>Carruseles de imÃ¡genes o productos ğŸ–¼ï¸</option>
                <option>Scroll infinito o paginaciÃ³n ğŸ“œ</option>
                <option>Mapas interactivos ğŸ—ºï¸</option>
                <option>Chatbots o asistentes ğŸ’¬</option>
              </optgroup>
              <optgroup label="ğŸ’¬ ComunicaciÃ³n y feedback">
                <option>Notificaciones push ğŸ””</option>
                <option>Pop-ups / modales emergentes ğŸ“¢</option>
                <option>Mensajes de error âš ï¸</option>
                <option>Tooltips â„¹ï¸</option>
                <option>Confirmaciones y validaciones âœ…</option>
                <option>Encuestas rÃ¡pidas o NPS ğŸ“Š</option>
              </optgroup>
              <optgroup label="ğŸ’³ Transacciones">
                <option>Carrito de compras ğŸ›’</option>
                <option>Checkout / proceso de pago ğŸ’³</option>
                <option>MÃ©todos de pago alternativos (PayPal, Apple Pay, etc.) ğŸª™</option>
                <option>ConfirmaciÃ³n de compra ğŸ“©</option>
                <option>Seguimiento de envÃ­o ğŸšš</option>
              </optgroup>
              <optgroup label="ğŸ‘¤ GestiÃ³n del usuario">
                <option>Perfil del usuario ğŸ‘¤</option>
                <option>ConfiguraciÃ³n y preferencias âš™ï¸</option>
                <option>Historial de actividades ğŸ—ƒï¸</option>
                <option>Favoritos o listas guardadas â­</option>
                <option>Suscripciones y membresÃ­as ğŸŸï¸</option>
              </optgroup>
              <optgroup label="ğŸ“ˆ Soporte y acompaÃ±amiento">
                <option>Centro de ayuda â“</option>
                <option>Preguntas frecuentes ğŸ“š</option>
                <option>Chat en vivo o tickets de soporte ğŸ§</option>
                <option>Foros / comunidad ğŸ‘¥</option>
                <option>Tutoriales o tours guiados ğŸ¥</option>
              </optgroup>
            </select>
          </div>

          <!-- Sensaciones y Recomendaciones -->
          <div>
            <label for="sensaciones" class="block text-sm font-medium mb-1">Sensaciones</label>
            <textarea id="sensaciones" name="sensaciones" rows="2" placeholder="Â¿QuÃ© sensaciones provoca esta etapa?" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500"></textarea>
          </div>
          <div>
            <label for="recomendaciones" class="block text-sm font-medium mb-1">Recomendaciones</label>
            <textarea id="recomendaciones" name="recomendaciones" rows="2" placeholder="Mejoras accionables para esta etapa" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500"></textarea>
          </div>

          <!-- Recorrido emocional (mini lÃ­nea de tiempo) -->
          <div class="md:col-span-2">
            <h3 class="font-semibold">ğŸ§  Recorrido emocional (mini lÃ­nea de tiempo)</h3>
            <div class="grid md:grid-cols-4 gap-3 mt-2">
              <div class="md:col-span-2">
                <label for="ev_evento" class="block text-sm font-medium mb-1">Evento/Hito</label>
                <input id="ev_evento" type="text" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Ve la oferta destacada" />
              </div>
              <div>
                <label for="ev_necesidad" class="block text-sm font-medium mb-1">Necesidad</label>
                <select id="ev_necesidad" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
                  <option value="">Seleccionaâ€¦</option>
                  <option>Rapidez / eficiencia âš¡</option>
                  <option>Seguridad / confianza ğŸ”’</option>
                  <option>Soporte / acompaÃ±amiento ğŸ’¬</option>
                  <option>Claridad / simplicidad ğŸ“</option>
                  <option>Accesibilidad / usabilidad ğŸ“±</option>
                  <option>SatisfacciÃ³n / logro âœ…</option>
                  <option>Ahorro / costo-beneficio ğŸ’°</option>
                  <option>Conectividad / disponibilidad ğŸ“¶</option>
                  <option>PersonalizaciÃ³n / adaptaciÃ³n ğŸ¨</option>
                  <option>Control / autonomÃ­a âš™ï¸</option>
                </select>
              </div>
              <div>
                <label for="ev_emocion" class="block text-sm font-medium mb-1">EmociÃ³n</label>
                <select id="ev_emocion" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
                  <option value="">Seleccionaâ€¦</option>
                  <option>ğŸ™‚ Satisfecho / contento</option>
                  <option>ğŸ˜Ÿ Preocupado / inseguro</option>
                  <option>ğŸ˜  Frustrado / molesto</option>
                  <option>ğŸ˜ Encantado / muy feliz</option>
                  <option>ğŸ¤¯ Abrumado / confundido</option>
                  <option>ğŸ˜ Neutral / indiferente</option>
                  <option>ğŸ˜¢ Triste / decepcionado</option>
                  <option>ğŸ˜¤ Irritado / impaciente</option>
                  <option>ğŸ˜ Confiado / seguro</option>
                  <option>ğŸ¤” Pensativo / evaluando</option>
                </select>
              </div>
              <div class="md:col-span-4">
                <label for="ev_pensamiento" class="block text-sm font-medium mb-1">Pensamiento ğŸ’­</label>
                <input id="ev_pensamiento" type="text" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Â¿QuÃ© piensa en ese hito?" />
              </div>
              <div class="md:col-span-4 no-print">
                <button id="addRecorrido" type="button" class="px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 text-sm font-semibold">Agregar al recorrido</button>
                <button id="clearRecorrido" type="button" class="ml-2 px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">Limpiar recorrido</button>
              </div>
              <div id="recorridoPreview" class="md:col-span-4 text-sm text-slate-600"></div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="md:col-span-2 flex flex-wrap gap-3 pt-2 no-print">
            <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Agregar etapa</button>
            <button type="reset" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Limpiar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Tips -->
    <aside class="space-y-6">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <h3 class="font-semibold text-lg mb-3">ğŸ“Œ Consejos</h3>
        <ul class="text-sm list-disc list-inside space-y-1">
          <li>Usa <strong>fases personalizadas</strong> (p. ej., "Descubrimiento", "Uso", "Post-servicio").</li>
          <li>Elige un <strong>touchpoint</strong> representativo por etapa.</li>
          <li>En el <strong>recorrido emocional</strong>, sÃ© concreto: evento, necesidad, emociÃ³n y ğŸ’­ pensamiento.</li>
          <li>Redacta <strong>recomendaciones</strong> accionables (quÃ©, para quiÃ©n, por quÃ©).</li>
        </ul>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <h3 class="font-semibold text-lg mb-3">ğŸ’¾ Guardado</h3>
        <p class="text-sm">Se almacena en <code>localStorage</code>. Exporta/Importa JSON para compartir.</p>
      </div>
    </aside>

    <!-- Visualizador: tabla con columnas DINÃMICAS por fase -->
    <section class="lg:col-span-3">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <h3 class="text-lg font-semibold">ğŸ‘€ Visualizador (fases dinÃ¡micas)</h3>
        <div class="overflow-x-auto" id="vizContainer">
          <!-- La tabla se genera dinÃ¡micamente vÃ­a JS -->
          <div class="text-sm text-slate-500" id="vizEmpty">AÃºn no hay etapas. Agrega la primera para ver las fases.</div>
        </div>
      </div>
    </section>

    <!-- Backlog -->
    <section class="lg:col-span-3">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
          <h2 class="text-xl font-semibold">Backlog de Viajes de Usuario</h2>
          <div class="text-xs text-slate-500">ID autogenerado (VJ-001, VJ-002...)</div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="journeyTable">
            <thead class="bg-slate-100">
              <tr>
                <th class="px-3 py-2 text-left">ID</th>
                <th class="px-3 py-2 text-left">Fase</th>
                <th class="px-3 py-2 text-left">DescripciÃ³n</th>
                <th class="px-3 py-2 text-left">Touchpoint</th>
                <th class="px-3 py-2 text-left">Sensaciones</th>
                <th class="px-3 py-2 text-left">Recomendaciones</th>
                <th class="px-3 py-2 text-left">Recorrido emocional</th>
                <th class="px-3 py-2 text-left no-print">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Estado y claves =====
    const KEY='userJourneys_v2';

    // ===== Refs DOM =====
    const form=document.getElementById('journeyForm');
    const tbody=document.getElementById('tbody');
    const recPrev=document.getElementById('recorridoPreview');
    const vizContainer=document.getElementById('vizContainer');
    const vizEmpty=document.getElementById('vizEmpty');

    // Recorrido emocional en memoria (antes de anexarlo a la etapa)
    let recorridoTmp=[];

    // ===== Utilidades =====
    function nextId(){
      const data=JSON.parse(localStorage.getItem(KEY)||'[]');
      return `VJ-${String(data.length+1).padStart(3,'0')}`;
    }
    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // ===== Render helpers =====
    function renderRecorridoInline(list){
      if(!list?.length) return '<span class="text-slate-400">Sin recorrido</span>';
      return `<div class='min-w-max flex items-center gap-2'>${list.map((it,i)=>`
        <div class='w-64 bg-white border border-slate-200 rounded-xl p-3 shadow-sm'>
          <div class='text-center'>
            <div class='text-xs text-slate-500 flex items-center justify-center gap-2'><span class='inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-600 text-white font-medium'>${i+1}</span>Hito</div>
            <div class='mt-1 font-semibold'>${escapeHtml(it.evento)}</div>
          </div>
          <div class='mt-2 text-center text-sm space-y-1'>
            ${it.necesidad?`<div><span class='inline-flex items-center gap-1 px-2 py-1 rounded-full border bg-white'>${escapeHtml(it.necesidad)}</span></div>`:''}
            <div>${it.emocion?escapeHtml(it.emocion):''} ${it.pensamiento?`<span class='ml-1'>ğŸ’­ ${escapeHtml(it.pensamiento)}</span>`:''}</div>
          </div>
        </div>
        ${i<list.length-1?`<div class='text-slate-400'>â†’</div>`:''}
      `).join('')}</div>`;
    }

    function cardEtapa(j){
      return `<div class='mb-3 last:mb-0'>
        <div class='bg-slate-50 border border-slate-200 rounded-xl p-3'>
          <div class='font-semibold mb-1'>${escapeHtml(j.descripcion)}</div>
          <div class='text-xs text-slate-600'><span class='font-medium'>Touchpoint:</span> ${escapeHtml(j.touchpoint)}</div>
          ${j.sensaciones?`<div class='text-xs mt-1'><span class='font-medium'>Sensaciones:</span> ${escapeHtml(j.sensaciones)}</div>`:''}
          ${j.recomendaciones?`<div class='text-xs mt-1 text-emerald-700'><span class='font-medium'>Recomendaciones:</span> ${escapeHtml(j.recomendaciones)}</div>`:''}
          <div class='mt-2'>${renderRecorridoInline(j.recorrido)}</div>
        </div>
      </div>`;
    }

    function renderVisualizer(){
      const data=JSON.parse(localStorage.getItem(KEY)||'[]');
      if(!data.length){
        vizContainer.innerHTML = '<div class="text-sm text-slate-500">AÃºn no hay etapas. Agrega la primera para ver las fases.</div>';
        return;
      }
      // Obtener fases Ãºnicas preservando el orden de primera apariciÃ³n
      const phases=[]; const seen=new Set();
      for(const j of data){ const f=(j.fase||'').trim(); if(f && !seen.has(f)){ seen.add(f); phases.push(f); } }
      if(!phases.length){
        vizContainer.innerHTML = '<div class="text-sm text-slate-500">Agrega una fase para construir la tabla.</div>';
        return;
      }
      const colsHtml = phases.map(p=>`<th class='px-3 py-2 text-left'>${escapeHtml(p)}</th>`).join('');
      const cellsHtml = phases.map(p=>{
        const items = data.filter(j=> (j.fase||'').trim()===p);
        const content = items.length ? items.map(cardEtapa).join('') : `<span class='text-slate-500'>Sin elementos</span>`;
        return `<td class='align-top px-3 py-3'>${content}</td>`;
      }).join('');
      vizContainer.innerHTML = `
        <table class='w-full text-sm'>
          <thead class='bg-slate-100'><tr>${colsHtml}</tr></thead>
          <tbody><tr>${cellsHtml}</tr></tbody>
        </table>`;
    }

    function addRow(j){
      const tr=document.createElement('tr');
      tr.className='border-b border-slate-200 align-top';
      tr.innerHTML=`
        <td class='px-3 py-2 font-semibold'>${j.id}</td>
        <td class='px-3 py-2'>${escapeHtml(j.fase)}</td>
        <td class='px-3 py-2'>${escapeHtml(j.descripcion)}</td>
        <td class='px-3 py-2'>${escapeHtml(j.touchpoint)}</td>
        <td class='px-3 py-2'>${escapeHtml(j.sensaciones||'')}</td>
        <td class='px-3 py-2'>${escapeHtml(j.recomendaciones||'')}</td>
        <td class='px-3 py-2'>${renderRecorridoInline(j.recorrido)}</td>
        <td class='px-3 py-2 no-print'><button class='text-rose-700 text-xs' data-id='${j.id}'>Eliminar</button></td>`;
      tbody.appendChild(tr);
    }

    function loadFromStorage(){
      const data=JSON.parse(localStorage.getItem(KEY)||'[]');
      tbody.innerHTML='';
      data.forEach(addRow);
      renderVisualizer();
    }

    function save(j){
      const data=JSON.parse(localStorage.getItem(KEY)||'[]');
      data.push(j);
      localStorage.setItem(KEY, JSON.stringify(data));
    }

    function removeById(id){
      const data=(JSON.parse(localStorage.getItem(KEY)||'[]')).filter(x=>x.id!==id);
      localStorage.setItem(KEY, JSON.stringify(data));
      loadFromStorage();
    }

    // ===== Recorrido emocional (UI) =====
    const evEvento=document.getElementById('ev_evento');
    const evNecesidad=document.getElementById('ev_necesidad');
    const evEmocion=document.getElementById('ev_emocion');
    const evPensamiento=document.getElementById('ev_pensamiento');

    function renderRecorridoPreview(){
      recPrev.innerHTML = renderRecorridoInline(recorridoTmp);
    }

    document.getElementById('addRecorrido').addEventListener('click',()=>{
      const item={
        evento: evEvento.value.trim(),
        necesidad: evNecesidad.value,
        emocion: evEmocion.value,
        pensamiento: evPensamiento.value.trim()
      };
      if(!item.evento || !item.necesidad || !item.emocion){
        [evEvento,evNecesidad,evEmocion].forEach(el=>{ if(!el.value || !el.value.trim()){ el.classList.add('error'); } else { el.classList.remove('error'); }});
        alert('Completa Evento, Necesidad y EmociÃ³n del recorrido');
        return;
      }
      [evEvento,evNecesidad,evEmocion].forEach(el=>el.classList.remove('error'));
      recorridoTmp.push(item);
      evEvento.value=''; evNecesidad.value=''; evEmocion.value=''; evPensamiento.value='';
      renderRecorridoPreview();
    });

    document.getElementById('clearRecorrido').addEventListener('click',()=>{
      recorridoTmp=[]; renderRecorridoPreview();
    });

    // ===== Form principal =====
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fase=form.fase.value.trim();
      const descripcion=form.descripcion.value.trim();
      const touchpoint=form.touchpoint.value;
      const sensaciones=form.sensaciones.value.trim();
      const recomendaciones=form.recomendaciones.value.trim();
      let valid=true;
      [['fase',fase],['descripcion',descripcion],['touchpoint',touchpoint]].forEach(([id,val])=>{
        const el=form[id]; if(!val){ el.classList.add('error'); valid=false; } else el.classList.remove('error');
      });
      if(!valid){ alert('Completa Fase, DescripciÃ³n y Touchpoint'); return; }
      const j={ id: nextId(), fase, descripcion, touchpoint, sensaciones, recomendaciones, recorrido: [...recorridoTmp] };
      save(j); addRow(j); renderVisualizer(); form.reset(); recorridoTmp=[]; renderRecorridoPreview();
    });

    // DelegaciÃ³n eliminar fila
    tbody.addEventListener('click', (e)=>{
      const id=e.target.getAttribute('data-id');
      if(id && confirm('Â¿Eliminar '+id+'?')) removeById(id);
    });

    // ===== Export/Import/Print =====
    document.getElementById('exportJSON').addEventListener('click',()=>{
      const data=JSON.parse(localStorage.getItem(KEY)||'[]');
      if(!data.length) return alert('Nada que exportar');
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='viaje_usuario.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
    });

    document.getElementById('importJSON').addEventListener('click',()=>document.getElementById('fileJSON').click());
    document.getElementById('fileJSON').addEventListener('change',async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{
        const arr=JSON.parse(await f.text());
        if(!Array.isArray(arr)) return alert('El JSON debe ser un arreglo');
        localStorage.setItem(KEY, JSON.stringify(arr));
        loadFromStorage();
      }catch(err){ alert('Error: '+err.message); }
      finally{ e.target.value=''; }
    });

    document.getElementById('clearAll').addEventListener('click',()=>{
      if(confirm('Â¿Vaciar todo?')){ localStorage.removeItem(KEY); loadFromStorage(); }
    });

    document.getElementById('printBtn').addEventListener('click',()=>window.print());

    // ===== Init =====
    loadFromStorage();
    renderRecorridoPreview();
  </script>
</body>
</html>
